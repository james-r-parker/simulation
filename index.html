<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blob Evolution</title>

    <!-- Meta Tags -->
    <meta name="description"
        content="A high-performance WebGL simulation of evolving blob agents. Watch them learn, eat, and reproduce in real-time with neural networks and GPU acceleration.">
    <meta name="keywords"
        content="evolution, simulation, genetic algorithm, neural network, webgl, javascript, ai, machine learning, gpu, physics">
    <meta name="author" content="Blob Evolution Team">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="robots" content="index, follow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://matrix.dotnethelp.co.uk/">
    <meta property="og:title" content="Blob Evolution v5.0 - Real-time AI Evolution Simulation">
    <meta property="og:description"
        content="Evolve autonomous AI agents in your browser with GPU acceleration. Watch neural networks learn, agents compete, and evolution unfold in real-time.">
    <meta property="og:image" content="https://matrix.dotnethelp.co.uk/public/preview.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt"
        content="Blob Evolution simulation showing colorful evolving agents in a dark environment">
    <meta property="og:site_name" content="Blob Evolution">
    <meta property="og:locale" content="en_US">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://matrix.dotnethelp.co.uk/">
    <meta property="twitter:title" content="Blob Evolution v5.0 - Real-time AI Evolution Simulation">
    <meta property="twitter:description"
        content="Evolve autonomous AI agents in your browser with GPU acceleration. Watch neural networks learn and evolution unfold in real-time.">
    <meta property="twitter:image" content="https://matrix.dotnethelp.co.uk/public/preview.png">
    <meta property="twitter:image:alt" content="Blob Evolution simulation showing colorful evolving agents">
    <meta property="twitter:site" content="@blob_evolution">
    <meta property="twitter:creator" content="@blob_evolution">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://matrix.dotnethelp.co.uk/">

    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div id="info-bar">
        <span id="info-pop">Population: 0</span>
        <span id="info-avg-e">Avg. Energy: 0</span>
        <span id="info-memory">Memory: 0MB</span>
        <span id="info-runtime">Runtime: 0s</span>
        <span id="info-fps">FPS: 0</span>
    </div>
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
        ‚ò∞
    </button>

    <!-- Sidebar (formerly dashboard) -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Learning Progress</h3>
        </div>

        <div class="sidebar-content">
            <div class="nav-links"
                style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center;">
                <a href="/about"
                    style="color: var(--neon-green); text-decoration: none; margin-right: 15px; font-weight: bold;">About</a>
                <a href="/blog" style="color: var(--neon-cyan); text-decoration: none; font-weight: bold;">Blog</a>
            </div>
            <!-- MERGED SURVIVAL & PERFORMANCE METRICS -->
            <div class="metric-card critical">
                <div class="card-header">üìä Survival & Performance</div>
                <div class="card-body">
                    <div>Avg Age: <strong id="avg-age" class="highlight-yellow">0</strong>s <span
                            class="sub-text">(Target: 60s+)</span></div>
                    <div>Mature Agents (‚â•900f): <span id="mature-agents" class="highlight-green">0</span> / <span
                            id="total-agents">0</span></div>
                    <div>Maturation Rate: <span id="maturation-rate" class="bold">0</span>%</div>
                    <div>Max Age: <span id="max-age" class="highlight-cyan">0</span>f</div>
                    <div class="metric-divider"></div>
                    <div>Best Fitness: <span id="fitness-value">0</span> (Œî: <span id="fitness-delta">0</span>)</div>
                    <div>Avg Fitness: <span id="avg-fitness-value">0</span></div>
                    <div>Learning Rate: <span id="learning-rate-value">0</span>/gen</div>
                    <div class="metric-divider"></div>
                    <div>Avg Collisions: <span id="avg-collisions">0</span></div>
                    <div>Avg Wall Hits: <span id="avg-wall-hits">0</span></div>
                    <div>Collision-Free %: <span id="collision-free-percent" class="highlight-green">0</span>%</div>
                    <div class="metric-divider"></div>
                    <div>Avg Energy: <span id="avg-energy">0</span></div>
                    <div>Avg Food Eaten: <span id="avg-food">0</span></div>
                    <div>Avg Kills: <span id="avg-kills">0</span></div>
                </div>
            </div>

            <!-- REPRODUCTION METRICS -->
            <div class="metric-card reproduction">
                <div class="card-header">üíï Reproduction Status</div>
                <div class="card-body">
                    <div>Sexual Offspring: <span id="total-sexual-offspring" class="highlight-green bold">0</span></div>
                    <div>Asexual Offspring: <span id="total-asexual-offspring">0</span></div>
                    <div>Avg Offspring/Agent: <span id="avg-offspring">0</span></div>
                    <div>Reproduction Events/min: <span id="reproduction-rate">0</span></div>
                </div>
            </div>

            <!-- GENE POOL & DIVERSITY -->
            <div class="metric-group" id="genetic-diversity-section">
                <div class="group-header">Genetic Diversity</div>
                <div class="group-body">
                    <div>Active Gene IDs: <span id="diversity-value">0</span></div>
                    <div>Stored Gene Pools: <span id="gene-pool-value">0</span></div>
                    <div>Qualified Agents: <span id="qualified-agents-value">0</span> <span class="sub-text">(All criteria)</span></div>
                    <div>Validation Queue: <span id="validation-queue-value">0</span> <span class="sub-text">(pending
                            re-test)</span></div>
                    <div>Mutation Rate: <span id="mutation-rate-value">0</span></div>
                </div>
            </div>

            <!-- QUALIFICATION CRITERIA -->
            <div class="metric-card qualification">
                <div class="card-header">‚úÖ Qualification Criteria</div>
                <div class="card-body">
                    <div class="sub-text" style="margin-bottom: 8px; font-size: 0.85em; opacity: 0.8;">Thresholds: F‚â•3000, Food‚â•4, Age‚â•15s, Explore‚â•2%, Nav‚â•0.5</div>
                    <div>Avg Exploration: <span id="avg-exploration-pct" class="highlight-cyan">0</span>%</div>
                    <div>Avg Turns to Food: <span id="avg-turns-to-food" class="highlight-green">0</span></div>
                    <div class="metric-divider"></div>
                    <div>Meet Fitness: <span id="meet-fitness">0</span> / <span class="total-agents-ref">0</span></div>
                    <div>Meet Food: <span id="meet-food">0</span> / <span class="total-agents-ref">0</span></div>
                    <div>Meet Age: <span id="meet-age">0</span> / <span class="total-agents-ref">0</span></div>
                    <div>Meet Exploration: <span id="meet-exploration">0</span> / <span class="total-agents-ref">0</span></div>
                    <div>Meet Navigation: <span id="meet-navigation">0</span> / <span class="total-agents-ref">0</span></div>
                </div>
            </div>

            <canvas id="fitness-chart" width="300" height="100" class="fitness-chart"></canvas>
        </div>
    </aside>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <h1>Blob Evolution</h1>
        <div id="loading-status">Initializing...</div>
        <div id="loading-progress">
            <div id="loading-progress-bar"></div>
        </div>
    </div>

    <div id="controls">
        <label for="gameSpeed" title="Speed" style="display: none;"><input type="range" id="gameSpeed" min="1" max="5" step="1" value="1">‚è©</label>
        <label for="maxAgents" title="Max Agents"><input type="range" id="maxAgents" min="10" max="100" step="5"
                value="100">üë•</label>
        <label for="foodRate" title="Food Rate"><input type="range" id="foodRate" min="0.1" max="2.0" step="0.1"
                value="0.4">üçé</label>
        <label for="mutationRate" title="Mutation Rate"><input type="range" id="mutationRate" min="0.01" max="0.5" step="0.01"
                value="0.01">üß¨</label>

        <label for="showRays" title="Show Rays"><input type="checkbox" id="showRays">üëÅÔ∏è</label>
        <label for="followBest" title="Follow Best"><input type="checkbox" id="followBest" checked>üéØ</label>
        <label for="useGpu" title="Use GPU"><input type="checkbox" id="useGpu" checked>‚ö°</label>
        <label for="autoAdjust" title="Auto Adjust"><input type="checkbox" id="autoAdjust" checked>üîÑ</label>
        <label for="aiSummaryMode" title="AI Summary Mode"><input type="checkbox" id="aiSummaryMode">ü§ñ</label>
        <button id="copyStats" title="Copy Stats">üìã</button>
        <button id="clearStorage" title="Clear Gene Pool">üóëÔ∏è</button>
        <button id="fullscreenBtn" title="Toggle Fullscreen">üñ•Ô∏è</button>
        <button id="wakeLock" title="Keep Screen Awake">üîã</button>
        <button id="shareBtn" title="Share Page">üì§</button>
    </div>
    <div id="canvas-container"></div>

    <!-- Agent Details Modal -->
    <aside id="agent-sidebar" class="sidebar collapsed">
        <div class="sidebar-header">
            <h3 id="modal-agent-id">Agent #000</h3>
            <div class="sidebar-actions">
                <button class="sidebar-save-btn" id="save-agent-btn" aria-label="Save to Gene Pool" title="Skip validation and save directly to gene pool">üíæ</button>
                <button class="sidebar-close-btn" id="close-agent-modal" aria-label="Close Agent Details">‚úï</button>
            </div>
        </div>

        <div class="sidebar-content agent-details">
            <div class="agent-header-info">
                <div class="agent-type-badge" id="modal-agent-type">FORAGER</div>
                <span class="agent-generation">Gen: <span id="modal-agent-gen">0</span></span>
            </div>

            <!-- Core Stats -->
            <div class="stats-section">
                <h4>Core Stats</h4>
                <div class="agent-stats-grid compact">
                    <div class="stat-item has-bar">
                        <span class="stat-label">Energy</span>
                        <div class="stat-bar-container">
                            <div class="stat-bar" id="modal-energy-bar" style="width: 50%"></div>
                        </div>
                        <span class="stat-value" id="modal-energy-val">100</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Fitness</span>
                        <span class="stat-value highlight-green" id="modal-fitness-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Age</span>
                        <span class="stat-value" id="modal-age-val">0s</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Temp</span>
                        <span class="stat-value" id="modal-temp-val">50.0¬∞C</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Food Eaten</span>
                        <span class="stat-value" id="modal-food-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Offspring</span>
                        <span class="stat-value" id="modal-offspring-val">0</span>
                    </div>
                </div>
            </div>

            <!-- Behavior Stats -->
            <div class="stats-section">
                <h4>Behavior</h4>
                <div class="agent-stats-grid compact">
                    <div class="stat-item">
                        <span class="stat-label">Kills</span>
                        <span class="stat-value" id="modal-kills-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Exploration</span>
                        <span class="stat-value" id="modal-exploration-val">0%</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Food Turns</span>
                        <span class="stat-value" id="modal-turns-food-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Smart Turns</span>
                        <span class="stat-value" id="modal-clever-turns-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Direction Œî</span>
                        <span class="stat-value" id="modal-direction-changes-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Speed Œî</span>
                        <span class="stat-value" id="modal-speed-changes-val">0</span>
                    </div>
                </div>
            </div>

            <!-- Survival Stats -->
            <div class="stats-section">
                <h4>Survival</h4>
                <div class="agent-stats-grid compact">
                    <div class="stat-item">
                        <span class="stat-label">Obstacle Turns</span>
                        <span class="stat-value" id="modal-turns-obstacles-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Food Approaches</span>
                        <span class="stat-value" id="modal-food-approaches-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Efficiency</span>
                        <span class="stat-value" id="modal-efficiency-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Obstacle Hits</span>
                        <span class="stat-value" id="modal-obstacle-hits-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Collisions</span>
                        <span class="stat-value" id="modal-collisions-val">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Survival Bonus</span>
                        <span class="stat-value" id="modal-survival-bonus-val">0</span>
                    </div>
                </div>
            </div>

            <!-- Fitness Modifiers -->
            <div class="stats-section">
                <h4>Fitness Modifiers</h4>
                <div class="agent-stats-grid compact">
                    <div class="stat-item">
                        <span class="stat-label">Survival Multi</span>
                        <span class="stat-value" id="modal-survival-multi-val">1.0x</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Circle Penalty</span>
                        <span class="stat-value" id="modal-circle-penalty-val">0</span>
                    </div>
                </div>
            </div>

            <!-- Neural Network Visualization -->
            <div class="stats-section">
                <h4>Neural Network</h4>
                <div class="nn-viz-container">
                    <canvas id="nn-viz-canvas" width="280" height="120"></canvas>
                </div>
            </div>
        </div>
    </aside>

    <!-- GPU.js removed - using WebGPU directly for better performance -->

    <script type="module">
        import { Simulation } from './js/game.js';

        const container = document.getElementById('canvas-container');
        const sim = new Simulation(container);

        // Share Button Functionality - Only show if Web Share API is supported
        const shareBtn = document.getElementById('shareBtn');
        if (shareBtn) {
            if (!navigator.share) {
                // Hide the button if Web Share API is not supported
                shareBtn.style.display = 'none';
            } else {
                // Add click handler only if supported
                shareBtn.addEventListener('click', async () => {
                    const shareData = {
                        title: 'Blob Evolution v5.0 - Real-time AI Evolution Simulation',
                        text: 'Evolve autonomous AI agents in your browser with GPU acceleration. Watch neural networks learn and evolution unfold in real-time!',
                        url: window.location.href
                    };

                    try {
                        await navigator.share(shareData);
                    } catch (error) {
                        console.error('Error sharing:', error);
                        alert('Sharing failed. Please try again.');
                    }
                });
            }
        }

        // Global reference to simulation for cleanup
        window.currentSimulation = null;

        // The game loop is now started internally by sim.init()
        sim.init().then(() => {
            // Store reference for cleanup
            window.currentSimulation = sim;

            // Resize to fill screen after initialization
            sim.resize();
            // Small delay to ensure DOM is fully ready
            setTimeout(() => {
                sim.resize();
            }, 100);

            // UI Logic
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');

            // Mobile detection: hide sidebar by default on mobile devices
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                sidebar.classList.add('collapsed');
            }

            // Sidebar Toggle - now always visible when sidebar is expanded
            const updateSidebarIcon = () => {
                const isCollapsed = sidebar.classList.contains('collapsed');
                sidebarToggle.textContent = isCollapsed ? '‚ò∞' : '‚úï';
            };

            // Initialize icon based on current state
            updateSidebarIcon();

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                updateSidebarIcon();
            });
        });

        // Cleanup on page unload to prevent memory leaks
        window.addEventListener('beforeunload', () => {
            if (window.currentSimulation && window.currentSimulation.destroy) {
                window.currentSimulation.destroy();
            }
        });

        // Note: Removed aggressive cleanup on visibility change as it destroys simulation
        // when user simply switches tabs or minimizes window. Only cleanup on actual page unload.
    </script>
</body>

</html>