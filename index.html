<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Blob Evolution v5.0 (WebGL)</title>

    <!-- Meta Tags -->
    <meta name="description"
        content="A high-performance WebGL simulation of evolving blob agents. Watch them learn, eat, and reproduce in real-time.">
    <meta name="keywords" content="evolution, simulation, genetic algorithm, neural network, webgl, javascript">
    <meta name="author" content="Blob Evolution Team">
    <meta name="theme-color" content="#0a0a0a">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://blobevolution.sim/">
    <meta property="og:title" content="Blob Evolution v5.0">
    <meta property="og:description" content="Real-time evolution simulation with neural networks and GPU physics.">
    <meta property="og:image" content="favicon.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://blobevolution.sim/">
    <meta property="twitter:title" content="Blob Evolution v5.0">
    <meta property="twitter:description" content="Real-time evolution simulation with neural networks and GPU physics.">
    <meta property="twitter:image" content="favicon.png">

    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div id="info-bar">
        <span id="info-pop">Population: 0</span>
        <span id="info-best">Best Agent: F: 0, A: 0s, O: 0, K: 0, Fd: 0</span>
        <span id="info-gen">Generation: 0</span>
        <span id="info-genepools">Gene Pools: 0</span>
        <span id="info-avg-e">Avg. Energy: 0</span>
        <span id="info-memory">Memory: 0MB</span>
        <span id="info-runtime">Runtime: 0s</span>
        <span id="info-fps">FPS: 0</span>
    </div>
    <!-- Sidebar Toggle Button -->
    <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle Sidebar">
        ‚ò∞
    </button>

    <!-- Sidebar (formerly dashboard) -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>Learning Progress</h3>
            <button id="about-btn" class="icon-btn" title="About Simulation">‚ÑπÔ∏è</button>
        </div>

        <div class="sidebar-content">
            <!-- MERGED SURVIVAL & PERFORMANCE METRICS -->
            <div class="metric-card critical">
                <div class="card-header">üìä Survival & Performance</div>
                <div class="card-body">
                    <div>Avg Age: <strong id="avg-age" class="highlight-yellow">0</strong>s <span
                            class="sub-text">(Target: 60s+)</span></div>
                    <div>Mature Agents (‚â•900f): <span id="mature-agents" class="highlight-green">0</span> / <span
                            id="total-agents">0</span></div>
                    <div>Maturation Rate: <span id="maturation-rate" class="bold">0</span>%</div>
                    <div>Max Age: <span id="max-age" class="highlight-cyan">0</span>f</div>
                    <div class="metric-divider"></div>
                    <div>Best Fitness: <span id="fitness-value">0</span> (Œî: <span id="fitness-delta">0</span>)</div>
                    <div>Avg Fitness: <span id="avg-fitness-value">0</span></div>
                    <div>Learning Rate: <span id="learning-rate-value">0</span>/gen</div>
                    <div class="metric-divider"></div>
                    <div>Avg Collisions: <span id="avg-collisions">0</span></div>
                    <div>Avg Wall Hits: <span id="avg-wall-hits">0</span></div>
                    <div>Collision-Free %: <span id="collision-free-percent" class="highlight-green">0</span>%</div>
                    <div class="metric-divider"></div>
                    <div>Avg Energy: <span id="avg-energy">0</span></div>
                    <div>Avg Food Eaten: <span id="avg-food">0</span></div>
                    <div>Avg Kills: <span id="avg-kills">0</span></div>
                </div>
            </div>

            <!-- REPRODUCTION METRICS -->
            <div class="metric-card reproduction">
                <div class="card-header">üíï Reproduction Status</div>
                <div class="card-body">
                    <div>Sexual Offspring: <span id="total-sexual-offspring" class="highlight-green bold">0</span></div>
                    <div>Asexual Offspring: <span id="total-asexual-offspring">0</span></div>
                    <div>Avg Offspring/Agent: <span id="avg-offspring">0</span></div>
                    <div>Reproduction Events/min: <span id="reproduction-rate">0</span></div>
                </div>
            </div>

            <!-- GENE POOL & DIVERSITY -->
            <div class="metric-group">
                <div class="group-header">Genetic Diversity</div>
                <div class="group-body">
                    <div>Active Gene IDs: <span id="diversity-value">0</span></div>
                    <div>Stored Gene Pools: <span id="gene-pool-value">0</span></div>
                    <div>Qualified Agents: <span id="qualified-agents-value">0</span> <span class="sub-text">(F‚â•20,
                            600f+)</span></div>
                    <div>Validation Queue: <span id="validation-queue-value">0</span> <span class="sub-text">(pending re-test)</span></div>
                    <div>Mutation Rate: <span id="mutation-rate-value">0</span></div>
                </div>
            </div>

            <!-- SIMPLIFIED MEMORY MONITORING -->
            <div class="metric-card memory">
                <div class="card-header">üß† Memory Monitor</div>
                <div class="card-body">
                    <div>Current Usage: <span id="current-memory" class="highlight-green bold">0MB</span></div>
                    <div>Total Entities: <span id="total-entity-count" class="highlight-cyan">0</span></div>
                </div>
            </div>

            <canvas id="fitness-chart" width="300" height="100" class="fitness-chart"></canvas>
        </div>
    </aside>

    <!-- About Modal -->
    <div id="about-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-modal" class="close-btn">&times;</span>
            <h2>About Blob Evolution v5.0</h2>
            <div class="modal-body">
                <p>Welcome to <strong>Blob Evolution</strong>, a high-performance WebGL simulation where autonomous
                    agents evolve to survive.</p>

                <h3>Core Features:</h3>
                <ul>
                    <li><strong>Neural Networks:</strong> Each blob has a brain that learns from its environment.</li>
                    <li><strong>Genetic Algorithm:</strong> Successful agents reproduce, passing on their genes.</li>
                    <li><strong>GPU Physics:</strong> Thousands of agents simulated in real-time using WebGL.</li>
                    <li><strong>Complex Behavior:</strong> Agents learn to find food, avoid walls, and interact.</li>
                </ul>

                <h3>How to Watch:</h3>
                <p>Observe the "Critical Survival Metrics" in the sidebar. Watch as the "Avg Age" increases over
                    generations, indicating that agents are learning to survive longer.</p>

                <p class="credits">Built with Vanilla JS & WebGL.</p>
            </div>
        </div>
    </div>

    <div id="controls">
        <label for="gameSpeed">Speed: <input type="range" id="gameSpeed" min="0.5" max="10" step="0.5"
                value="10"></label>
        <label for="maxAgents">Max Agents: <input type="range" id="maxAgents" min="10" max="100" step="5"
                value="100"></label>

        <label for="showRays">Show Rays <input type="checkbox" id="showRays" checked></label>
        <label for="followBest">Follow Best <input type="checkbox" id="followBest" checked></label>
        <label for="useGpu">Use GPU <input type="checkbox" id="useGpu" checked></label>
        <label for="foodRate">Food Rate: <input type="range" id="foodRate" min="0.1" max="2.0" step="0.1"
                value="1.0"></label>
        <label for="mutationRate">Mutation Rate: <input type="range" id="mutationRate" min="0.01" max="0.5" step="0.01"
                value="0.1"></label>
        <button id="copyStats" title="Copy Stats">üìã</button>
        <button id="clearStorage" title="Clear Gene Pool">üóëÔ∏è</button>
    </div>
    <div id="canvas-container"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <h1>Blob Evolution</h1>
        <div id="loading-status">Initializing...</div>
        <div id="loading-progress">
            <div id="loading-progress-bar"></div>
        </div>
    </div>

    <!-- GPU.js removed - using WebGPU directly for better performance -->

    <script type="module">
        import { Simulation } from './js/game.js';

        const container = document.getElementById('canvas-container');
        const sim = new Simulation(container);

        // The game loop is now started internally by sim.init()
        sim.init().then(() => {
            // Resize to fill screen after initialization
            sim.resize();
            // Small delay to ensure DOM is fully ready
            setTimeout(() => {
                sim.resize();
            }, 100);

            // UI Logic
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const aboutBtn = document.getElementById('about-btn');
            const aboutModal = document.getElementById('about-modal');
            const closeModal = document.getElementById('close-modal');

            // Sidebar Toggle
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '‚ò∞' : '‚úï';
            });

            // About Modal
            aboutBtn.addEventListener('click', () => {
                aboutModal.classList.remove('hidden');
            });

            closeModal.addEventListener('click', () => {
                aboutModal.classList.add('hidden');
            });

            // Close modal on outside click
            aboutModal.addEventListener('click', (e) => {
                if (e.target === aboutModal) {
                    aboutModal.classList.add('hidden');
                }
            });
        });
    </script>
</body>

</html>